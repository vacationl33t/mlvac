from transformers import AutoProcessor, BarkModel
from scipy.io.wavfile import write as write_wav
import uuid

processor = AutoProcessor.from_pretrained("suno/bark")
model = BarkModel.from_pretrained("suno/bark")

def gen_text(text):

  voice_preset = "v2/en_speaker_6"
  inputs = processor(text, voice_preset=voice_preset, return_tensors="pt")

  attention_mask = inputs["attention_mask"]

  outputs = model.generate(
    input_ids=inputs["input_ids"], 
    attention_mask=attention_mask,
    pad_token_id=processor.tokenizer.pad_token_id
  )

  filename = "app/voice/" + str(uuid.uuid4()) + ".wav"
  audio_array = model.generate(**inputs)
  audio_array = audio_array.cpu().numpy().squeeze()
  sample_rate = model.generation_config.sample_rate
  write_wav(filename, sample_rate, audio_array)
  return filename